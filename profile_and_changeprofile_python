class ChangeForm(FlaskForm):
    email = EmailField('Login / email', validators=[DataRequired()])
    old_password = PasswordField('OLD Password', validators=[DataRequired()])
    new_password = PasswordField('New Password', validators=[DataRequired()])
    password_again = PasswordField('Repeat new password', validators=[DataRequired()])
    surname = StringField('Surname', validators=[DataRequired()])
    name = StringField('Name', validators=[DataRequired()])
    age = IntegerField('Age')
    position = StringField('Position')
    speciality = StringField('Speciality')
    address = StringField("Address")
    submit = SubmitField('Register')


@app.route('/profile', methods=['GET', 'POST'])
def profile():
    return f'''<!doctype html>
                        <html lang="en">
                          <head>
                            <meta charset="utf-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
                            <link rel="stylesheet" 
                            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" 
                            integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" 
                            crossorigin="anonymous">
                            <title>Колонизация</title>
                          </head>
                          <body>
                            <h1>{current_user.name}, это ваш профиль</h1>
                            <div class="alert alert-danger" role="alert">
                              Чтобы изменить данные, напишите в поисковой строке /changeprofile
                            </div>
                            <div class="alert alert-danger" role="alert">
                              Ваш email: {current_user.email}
                            </div>
                            <div class="alert alert-warning" role="alert">
                              Ваша фамилия: {current_user.surname}
                            </div>
                            <div class="alert alert-secondary" role="alert">
                              Ваш возраст: {current_user.age}
                            </div>
                            <div class="alert alert-success" role="alert">
                              Ваш адрес: {current_user.adress}
                            </div>
                            <div class="alert alert-dark" role="alert">
                            '''


@app.route('/changeprofile', methods=['GET', 'POST'])
def changeprofile():
    form = ChangeForm()
    if form.validate_on_submit():
        db_sess = db_session.create_session()
        user = db_sess.query(User).filter(User.email == form.email.data).first()
        if not user.check_password(form.old_password.data):
            return render_template('changeprofile.html', title='Change form',
                                   form=form,
                                   message="Неверный старый пароль!")
        if form.new_password.data != form.password_again.data:
            return render_template('changeprofile.html', title='Change form',
                                   form=form,
                                   message="New password и Repeat new password не совпадают")
        if not db_sess.query(User).filter(User.email == form.email.data).first():
            return render_template('changeprofile.html', title='Change form',
                                   form=form,
                                   message="Вы пытаетесь стать новым пользователем")
        else:
            user.name = form.name.data
            user.email = form.email.data
            user.surname = form.surname.data
            user.age = form.age.data
            user.position = form.position.data
            user.address = form.address.data
            user.speciality = form.speciality.data
            user.set_password(form.new_password.data)
            db_sess.commit()
        return redirect(f'/login')
    return render_template('changeprofile.html', title='Register form', form=form)
